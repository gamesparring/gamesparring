(function(b){if(typeof define==="function"&&define.amd){define(["jquery"],b)}else{b(jQuery)}}(function(j){var g=0;j.fn.mosaicflow=function(a){var b=Array.prototype.slice.call(arguments,0);return this.each(function(){var c=j(this);var d=c.data("mosaicflow");if(!d){a=j.extend({},j.fn.mosaicflow.defaults,a,i(c));d=new f(c,a);c.data("mosaicflow",d)}else{if(typeof a==="string"){d[a](b[1])}}})};j.fn.mosaicflow.defaults={itemSelector:"> *",columnClass:"mosaicflow__column",minItemWidth:240,minColumns:2,itemHeightCalculation:"auto",threshold:40};function f(b,a){this.container=b;this.options=a;this.container.trigger("mosaicflow-start");this.init();this.container.trigger("mosaicflow-ready")}f.prototype={init:function(){this.__uid=g++;this.__uidItemCounter=0;this.items=this.container.find(this.options.itemSelector);this.columns=j([]);this.columnsHeights=[];this.itemsHeights={};this.tempContainer=j("<div>").css({visibility:"hidden",width:"100%"});this.workOnTemp=false;this.autoCalculation=this.options.itemHeightCalculation==="auto";this.container.append(this.tempContainer);var a=this;this.items.each(function(){var b=j(this);var c=b.attr("id");if(!c){c=a.generateUniqueId();b.attr("id",c)}});this.container.css("visibility","hidden");if(this.autoCalculation){j(window).on("load",j.proxy(this.refill,this))}else{this.refill()}j(window).resize(j.proxy(this.refill,this))},refill:function(){this.container.trigger("mosaicflow-fill");this.numberOfColumns=Math.floor(this.container.width()/this.options.minItemWidth);if(this.numberOfColumns<this.options.minColumns){this.numberOfColumns=this.options.minColumns}var a=this.ensureColumns();if(a){this.fillColumns();if(this.columns.filter(":visible").length>0){this.columns.filter(":hidden").remove()}}this.container.css("visibility","visible");this.container.trigger("mosaicflow-filled")},ensureColumns:function(){var m=this.columns.filter(":visible").length;var e=this.numberOfColumns;this.workingContainer=m===0?this.tempContainer:this.container;if(e>m){var b=e-m;for(var c=0;c<b;c++){var d=j("<div>",{"class":this.options.columnClass});this.workingContainer.append(d)}}else{if(e<m){var n=m;while(e<=n){this.columns.eq(n).hide();n--}var a=m-e;this.columnsHeights.splice(this.columnsHeights.length-a,a)}}if(e!==m){this.columns=this.workingContainer.find("."+this.options.columnClass);this.columns.css("width",(100/e)+"%");return true}return false},fillColumns:function(){var a=this.numberOfColumns;var m=this.items.length;for(var b=0;b<a;b++){var e=this.columns.eq(b);this.columnsHeights[b]=0;for(var c=b;c<m;c+=a){var d=this.items.eq(c);var n=0;e.append(d);if(this.autoCalculation){n=d.outerHeight()}else{n=parseInt(d.find("img").attr("height"),10)}this.itemsHeights[d.attr("id")]=n;this.columnsHeights[b]+=n}}this.levelBottomEdge(this.itemsHeights,this.columnsHeights);if(this.workingContainer===this.tempContainer){this.container.append(this.tempContainer.children())}this.container.trigger("mosaicflow-layout")},levelBottomEdge:function(b,e){while(true){var d=j.inArray(Math.min.apply(null,e),e);var q=j.inArray(Math.max.apply(null,e),e);if(d===q){return}var o=this.columns.eq(q).children().last();var r=b[o.attr("id")];var p=e[d];var c=e[q];var a=p+r;if(a>=c){return}if(c-a<this.options.threshold){return}this.columns.eq(d).append(o);e[q]-=r;e[d]+=r}},add:function(a){this.container.trigger("mosaicflow-item-add",[a]);var c=j.inArray(Math.min.apply(null,this.columnsHeights),this.columnsHeights);var e=0;if(this.autoCalculation){a.css({position:"static",visibility:"hidden",display:"block"}).appendTo(this.columns.eq(c));e=a.outerHeight();var d=a.find("img");if(d.length!==0){d.each(function(){var o=j(this);var p=h(o);var n=(o.width()*p.height)/p.width;e+=n})}a.detach().css({position:"static",visibility:"visible"})}else{e=parseInt(a.find("img").attr("height"),10)}if(!a.attr("id")){a.attr("id",this.generateUniqueId())}var b=this.items.toArray();b.push(a);this.items=j(b);this.itemsHeights[a.attr("id")]=e;this.columnsHeights[c]+=e;this.columns.eq(c).append(a);this.levelBottomEdge(this.itemsHeights,this.columnsHeights);this.container.trigger("mosaicflow-layout");this.container.trigger("mosaicflow-item-added",[a])},remove:function(a){this.container.trigger("mosaicflow-item-remove",[a]);var b=a.parents("."+this.options.columnClass);this.columnsHeights[b.index()-1]-=this.itemsHeights[a.attr("id")];a.detach();this.items=this.items.not(a);this.levelBottomEdge(this.itemsHeights,this.columnsHeights);this.container.trigger("mosaicflow-layout");this.container.trigger("mosaicflow-item-removed",[a])},empty:function(){var a=this.numberOfColumns;this.items=j([]);this.itemsHeights={};for(var b=0;b<a;b++){var c=this.columns.eq(b);this.columnsHeights[b]=0;c.empty()}this.container.trigger("mosaicflow-layout")},recomputeHeights:function(){function e(o,n){n=j(n);var p=0;if(b.autoCalculation){p=n.outerHeight()}else{p=parseInt(n.find("img").attr("height"),10)}b.itemsHeights[n.attr("id")]=p;b.columnsHeights[c]+=p}var b=this;var a=this.numberOfColumns;for(var c=0;c<a;c++){var d=this.columns.eq(c);this.columnsHeights[c]=0;d.children().each(e)}},generateUniqueId:function(){this.__uidItemCounter++;return"mosaic-"+this.__uid+"-itemid-"+this.__uidItemCounter}};function i(b){function c(l,m){return m.toUpper()}var e={};var a=b.data();for(var d in a){e[d.replace(/-(\w)/g,c)]=a[d]}return e}function h(a){var b={};b.height=parseInt(a.attr("height"),10);b.width=parseInt(a.attr("width"),10);if(b.height===0||b.width===0){var c=new Image();c.src=a.attr("src");b.width=c.width;b.height=c.height}return b}j(function(){j(".mosaicflow").mosaicflow()})}));